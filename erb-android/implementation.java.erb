// DO NOT MODIFY!
// Generated by O/R mapper generator ver <%= VER %>.

package <%= vers["PKGNAME"] %>;

import org.tmurakam.ormapper.ORDatabase;
import org.tmurakam.ormapper.ORRecord;
import org.tmurakam.ormapper.ORQuery;

import android.content.ContentValues;
import android.database.*;
import android.database.sqlite.*;
import android.util.Log;

import java.util.*;
import java.io.*;

public class <%= cdef.baseClassName %> extends ORRecord {
    public final static String TAG = "<%= cdef.baseClassName %>";

    public final static String tableName = "<%= cdef.tableName %>";

    private final static String[] COLUMN_TYPES = {
<% cdef.members.each do |m| -%>
        "<%= m.fieldName %>", "<%= m.type %>",
<% end -%>
    };

<%
  # declare member variables
  cdef.members.each do |m|
    type = getJavaType(m.type)
-%>
    protected <%= type %> <%= m.memberName %>;
<% end -%>

    // getter / setter
<%
  # declare getter / setter
  cdef.members.each do |m|
    type = getJavaType(m.type)
-%>
    public <%= type %> <%= m.getter %>() {
        return <%=m.memberName%>;
    }

    public void <%= m.setter %>(<%= type %> <%= m.propName %>) {
        this.<%= m.memberName %> = <%= m.propName %>;
    }
<% end -%>

    /**
     * Migrate database table
     * @return true - table was newly created, false - table already exists
     */
    public static boolean migrate() {
        return migrate(tableName, COLUMN_TYPES);
    }

    // Constructor
    public <%= cdef.baseClassName %>() {
        super();
    }

    // Read operations

    /**
     * Get the record matches the id
     * @param pid Primary key of the record
     * @return record
     */
    public static <%= cdef.className %> find(int pid) {
        return query().where("key = ?;", Integer.toString(pid)).first();
    }

<%  # find_by finders -%>
<%  cdef.members.each do |m| -%>

    public static <%= cdef.className %> find_by_<%= m.fieldName %>(<%= getJavaType(m.type) %> key) {
        return query().where("<%= m.fieldName %> = ?", <%= getToString(m.type, "key") %>).first();
    }
<% end -%>

    /**
     * get ORQuery
     */
    public static ORQuery<<%= cdef.className %>> query() {
        return new ORQuery<<%= cdef.className %>>(<%= cdef.className %>.class, tableName);
    }

    /* shortcuts to ORQuery functions */

    /**
     * Execute query and returns all elements
     * @return elements
     */
    public static List<<%= cdef.className %>> all() {
        return query().all();
    }

    /**
     * Execute query and get first element
     * @return first element
     */
    public static <%= cdef.className %> first() {
        return query().first();
    }

    /**
     * Set 'WHERE' conditions
     * @param cond conditions
     * @param params parameters for each placeholders
     * @return this
     * @note You can set only 1 where condition.
     */
    public static ORQuery<<%= cdef.className %>> where(String cond, String... params) {
        return query().where(cond, params);
    }

    /**
     * Set 'WHERE' conditions
     * @param column column name
     * @param param parameter
     * @return this
     * @note You can set only 1 where condition.
     */
    public static ORQuery<<%= cdef.className %>> where_eq(String column, String param) {
        return query().where_eq(column, param);
    }

    /**
     * set 'ORDER BY' parameter
     * @param order ORDER BY parameter string
     * @return this
     */
    public static ORQuery<<%= cdef.className %>> order(String order) {
        return query().order(order);
    }

    /**
     * set 'LIMIT' parameter 
     * @param limit parameter
     * @return this
     */
    public static ORQuery<<%= cdef.className %>> limit(int limit) {
        return query().limit(limit);
    }

    /* load row columns */
    public void _loadRow(Cursor cursor) {
        this.pid = cursor.getInt(0);

<% 
  i = 1
  cdef.members.each do |m|
    type = m.type
    if (type == "DATE")
-%>
        this.<%= m.memberName %> = ORDatabase.str2date(cursor.getString(<%= i %>));
<%  else -%>
<%   method = getMethodType(type); -%>
        this.<%= m.memberName %> = cursor.get<%= method %>(<%= i %>);
<%
    end
    i+=1
  end
-%>

        isInserted = true;
    }

    // Create operations

    public void insert() {
        super.insert();

        SQLiteDatabase db = ORDatabase.getDB();

        db.beginTransaction();
        try {
            // TODO: pid should be long?
            this.pid = (int)db.insert(tableName, "key", getContentValues());
            isInserted = true;
            Log.d(TAG, "<%= cdef.tableName %>.insert : pid = " + pid);

            db.setTransactionSuccessful();
        } finally {
            db.endTransaction();
        }
    }

    // Update operations

    public void update() {
        SQLiteDatabase db = ORDatabase.getDB();
        db.beginTransaction();
        try {
            ContentValues cv = getContentValues();

            String[] whereArgs = {
                Long.toString(pid)
            };
            int n = db.update(tableName, cv, "key = ?", whereArgs);
            Log.d(TAG, "<%= cdef.tableName %>.update : count = " + n);
            db.setTransactionSuccessful();
        } finally {
            db.endTransaction();
        }
    }

    private ContentValues getContentValues() {
        ContentValues cv = new ContentValues();

<%
  i = 1
  cdef.members.each do |m|
    if (m.type == "DATE")
-%>
        cv.put("<%= m.fieldName %>", ORDatabase.date2str(this.<%= m.memberName %>));
<%  else -%>
        cv.put("<%= m.fieldName %>", this.<%= m.memberName %>);
<%  end -%>
<% end -%>

        return cv;
    }

    // Delete operations

    /**
     * Delete this record
     */
    public void delete() {
        SQLiteDatabase db = ORDatabase.getDB();

        String[] whereArgs = {
            Long.toString(pid)
        };
        int n = db.delete(tableName, "key = ?", whereArgs);
        Log.d(TAG, "<%= cdef.tableName %>.delete : n = " + n);
    }

    /**
     * Delete records
     * @param cond Conditions
     */
    public static void delete(String cond) {
        SQLiteDatabase db = ORDatabase.getDB();

        if (cond == null) {
            cond = "";
        }
        String sql = "DELETE FROM " + tableName + " " + cond;
        db.execSQL(sql);
    }

    public static void delete_all() {
        delete(null);
    }

    /**
     * get table sql
     */
    public static void getTableSql(Writer wr) throws IOException {
        wr.write(String.format("DROP TABLE %s;\n", tableName));
        wr.write(String.format("CREATE TABLE %s (key INTEGER PRIMARY KEY", tableName));

        for (int i = 0; i < COLUMN_TYPES.length / 2; i++) {
            wr.write(String.format(", %s %s", 
                                  COLUMN_TYPES[i*2], COLUMN_TYPES[i*2+1]));
        }
        wr.write(");\n");

        List<<%= cdef.className %>> ary = query().all();
        for (<%= cdef.className %> e : ary) {
            e.getInsertSql(wr);
            wr.write("\n");
        }
    }

    /**
     * get "INSERT" SQL
     */
    public void getInsertSql(Writer wr) throws IOException {
        wr.write("INSERT INTO ");
        wr.write(tableName);
        wr.write(String.format(" VALUES(%d", pid));
<% cdef.members.each do |m| -%>
        wr.write(",");
        wr.write(quoteSqlString(<%= getToString(m.type, m.memberName) %>));
<% end -%>
        wr.write(");");
    }
}

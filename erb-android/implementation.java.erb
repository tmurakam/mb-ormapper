// DO NOT MODIFY!
// Generated by O/R mapper generator ver <%= VER %>.

package <%= vers["PKGNAME"] %>;

import org.tmurakam.ormapper.ORDatabase;
import org.tmurakam.ormapper.ORRecord;

import android.content.ContentValues;
import android.database.*;
import android.database.sqlite.*;
import android.util.Log;

import java.util.*;
import java.io.*;

public class <%= cdef.baseClassName %> extends ORRecord {
    public final static String TAG = "ORMapper";

    public final static String tableName = "<%= cdef.tableName %>";

    private final static String[] COLUMN_TYPES = {
<% cdef.members.each do |m| -%>
        "<%= m.fieldName %>", "<%= m.type %>",
<% end -%>
    };

<%
  # declare member variables
  cdef.members.each do |m|
    type = getJavaType(m.type)
-%>
    protected <%= type %> <%= m.memberName %>;
<% end -%>

    // getter / setter
<%
  # declare getter / setter
  cdef.members.each do |m|
    type = getJavaType(m.type)
-%>
    public <%= type %> <%= m.getter %>() {
        return <%=m.memberName%>;
    }

    public void <%= m.setter %>(<%= type %> <%= m.propName %>) {
        this.<%= m.memberName %> = <%= m.propName %>;
    }
<% end -%>

    /**
     * Migrate database table
     * @return true - table was newly created, false - table already exists
     */
    public static boolean migrate() {
        return migrate(tableName, COLUMN_TYPES);
    }

    // Constructor
    public <%= cdef.baseClassName %>() {
        super();
    }

    // Read operations

    /**
     * Get all records
     * @return array of all record
     */
    public static List<<%= cdef.className %>> find() {
        return find(null, null);
    }

    /**
     * Get the record matches the id
     * @param pid Primary key of the record
     * @return record
     */
    public static <%= cdef.className %> find(int pid) {
        String[] param = { Integer.toString(pid) };
        return findFirst("WHERE key = ?;", param);
    }

<%  # find_by finders -%>
<%  cdef.members.each do |m| -%>

    public static <%= cdef.className %> find_by_<%= m.fieldName %>(<%= getJavaType(m.type) %> key) {
        String[] param = { <%= getToString(m.type, "key") %> };
        return findFirst("WHERE <%= m.fieldName %> = ?;", param);
    }
<% end -%>

    /**
     * Get all records matches the conditions
     * @param cond Conditions (WHERE phrase and so on)
     * @return array of records
     */
    public static List<<%= cdef.className %>> find(String cond) {
        return find(cond, null);
    }

    /**
     * Get all records match the conditions
     * @param cond Conditions (WHERE phrase and so on)
     * @param params parameters
     * @return array of records
     */
    public static List<<%= cdef.className %>> find(String cond, String[] params) {
        String sql;
        sql = "SELECT * FROM " + tableName;
        if (cond != null) {
            sql += " ";
            sql += cond;
        }
        SQLiteDatabase db = ORDatabase.getDB();
        Cursor cursor = db.rawQuery(sql, params);
        cursor.moveToFirst();

        ArrayList<<%= cdef.className %>> array = new ArrayList<<%= cdef.className %>>();

        while (!cursor.isAfterLast()) {
            <%= cdef.className %> e = new <%= cdef.className %>();
            e._loadRow(cursor);
            array.add(e);
            cursor.moveToNext();
        }
        cursor.close();

        return array;
    }

    /**
     * Get first record matches the conditions
     * @param cond Conditions (WHERE phrase and so on)
     * @param params parameters
     * @return record
     */
    public static <%= cdef.className %> findFirst(String cond, String[] params) {
        String sql;
        sql = "SELECT * FROM " + tableName;
        if (cond != null) {
            sql += " ";
            sql += cond;
        }
        SQLiteDatabase db = ORDatabase.getDB();
        Cursor cursor = db.rawQuery(sql, params);
        cursor.moveToFirst();

        <%= cdef.className %> e = null;
        if (!cursor.isAfterLast()) {
            e = new <%= cdef.className %>();
            e._loadRow(cursor);
        }
        cursor.close();

        return e;
    }

    protected void _loadRow(Cursor cursor) {
        this.pid = cursor.getInt(0);

<% 
  i = 1
  cdef.members.each do |m|
    type = m.type
    if (type == "DATE")
-%>
        this.<%= m.memberName %> = ORDatabase.str2date(cursor.getString(<%= i %>));
<%  else -%>
<%   method = getMethodType(type); -%>
        this.<%= m.memberName %> = cursor.get<%= method %>(<%= i %>);
<%
    end
    i+=1
  end
-%>

        isInserted = true;
    }

    // Create operations

    public void insert() {
        super.insert();

        SQLiteDatabase db = ORDatabase.getDB();

        db.beginTransaction();
        try {
            // TODO: pid should be long?
            this.pid = (int)db.insert(tableName, "key", getContentValues());
            isInserted = true;
            Log.d(TAG, "<%= cdef.tableName %>.insert : pid = " + pid);

            db.setTransactionSuccessful();
        } finally {
            db.endTransaction();
        }
    }

    // Update operations

    public void update() {
        SQLiteDatabase db = ORDatabase.getDB();
        db.beginTransaction();
        try {
            ContentValues cv = getContentValues();

            String[] whereArgs = {
                Long.toString(pid)
            };
            int n = db.update(tableName, cv, "key = ?", whereArgs);
            Log.d(TAG, "<%= cdef.tableName %>.update : count = " + n);
            db.setTransactionSuccessful();
        } finally {
            db.endTransaction();
        }
    }

    private ContentValues getContentValues() {
        ContentValues cv = new ContentValues();

<%
  i = 1
  cdef.members.each do |m|
    if (m.type == "DATE")
-%>
        cv.put("<%= m.fieldName %>", ORDatabase.date2str(this.<%= m.memberName %>));
<%  else -%>
        cv.put("<%= m.fieldName %>", this.<%= m.memberName %>);
<%  end -%>
<% end -%>

        return cv;
    }

    // Delete operations

    /**
     * Delete this record
     */
    public void delete() {
        SQLiteDatabase db = ORDatabase.getDB();

        String[] whereArgs = {
            Long.toString(pid)
        };
        int n = db.delete(tableName, "key = ?", whereArgs);
        Log.d(TAG, "<%= cdef.tableName %>.delete : n = " + n);
    }

    /**
     * Delete records
     * @param cond Conditions
     */
    public static void delete(String cond) {
        SQLiteDatabase db = ORDatabase.getDB();

        if (cond == null) {
            cond = "";
        }
        String sql = "DELETE FROM " + tableName + " " + cond;
        db.execSQL(sql);
    }

    public static void delete_all() {
        delete(null);
    }

    /**
     * get table sql
     */
    public static void getTableSql(Writer wr) throws IOException {
        wr.write(String.format("DROP TABLE %s;\n", tableName));
        wr.write(String.format("CREATE TABLE %s (key INTEGER PRIMARY KEY", tableName));

        for (int i = 0; i < COLUMN_TYPES.length / 2; i++) {
            wr.write(String.format(", %s %s", 
                                  COLUMN_TYPES[i*2], COLUMN_TYPES[i*2+1]));
        }
        wr.write(");\n");

        List<<%= cdef.className %>> ary = find();
        for (<%= cdef.className %> e : ary) {
            e.getInsertSql(wr);
            wr.write("\n");
        }
    }

    /**
     * get "INSERT" SQL
     */
    public void getInsertSql(Writer wr) throws IOException {
        wr.write("INSERT INTO ");
        wr.write(tableName);
        wr.write(String.format(" VALUES(%d", pid));
<% cdef.members.each do |m| -%>
        wr.write(",");
        wr.write(quoteSqlString(<%= getToString(m.type, m.memberName) %>));
<% end -%>
        wr.write(");");
    }
}

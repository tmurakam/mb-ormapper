// Generated by O/R mapper generator ver <%= VER %>

#import "Database.h"
#import "<%= cdef.baseClassName %>.h"

@implementation <%= cdef.baseClassName %>

<% cdef.members.each do |m| -%>
@synthesize <%= m.propName %> = <%= m.memberName %>;
<% end -%>

- (id)init
{
    self = [super init];
    return self;
}

/**
  @brief Migrate database table

  @return YES - table was newly created, NO - table already exists
*/

+ (BOOL)migrate
{
    NSArray *columnTypes = @[
<% cdef.members.each do |m| -%>
        @"<%= m.fieldName %>", @"<%= m.type %>",
<% end -%>
        ];

    return [super migrate:columnTypes primaryKey:@"<%= vers["PKEY"] %>"];
}

#pragma mark Read operations

/**
  @brief get the record matchs the id

  @param pid Primary key of the record
  @return record
*/
+ (<%= cdef.className %> *)find:(int)pid
{
    Database *db = [Database instance];

    dbstmt *stmt = [db prepare:@"SELECT * FROM <%= cdef.tableName %> WHERE <%= vers["PKEY"] %> = ?;"];
    [stmt bindInt:0 val:pid];

    return [self find_first_stmt:stmt];
}

<%
  cdef.members.each do |m|
    type, mem = getObjcType(m.type)
-%>
/**
  finder with <%= m.fieldName %>

  @param key Key value
  @param cond Conditions (ORDER BY etc)
  @note If you specify WHERE conditions, you must start cond with "AND" keyword.
*/
+ (<%= cdef.className %>*)find_by_<%= m.fieldName %>:(<%= type %>)key cond:(NSString *)cond
{
    if (cond == nil) {
        cond = @"WHERE <%= m.fieldName %> = ? LIMIT 1";
    } else {
        cond = [NSString stringWithFormat:@"WHERE <%= m.fieldName %> = ? %@ LIMIT 1", cond];
    }
    dbstmt *stmt = [self gen_stmt:cond];
    [stmt bind<%= getMethodType(m.type) %>:0 val:key];
    return [self find_first_stmt:stmt];
}

+ (<%= cdef.className %>*)find_by_<%= m.fieldName %>:(<%= type %>)key
{
    return [self find_by_<%= m.fieldName %>:key cond:nil];
}

<% end -%>

/**
  Get first record matches the conditions

  @param cond Conditions (WHERE phrase and so on)
  @return array of records
*/
+ (<%= cdef.className %> *)find_first:(NSString *)cond
{
    if (cond == nil) {
        cond = @"LIMIT 1";
    } else {
        cond = [cond stringByAppendingString:@" LIMIT 1"];
    }
    dbstmt *stmt = [self gen_stmt:cond];
    return  [self find_first_stmt:stmt];
}

/**
  Get all records match the conditions

  @param cond Conditions (WHERE phrase and so on)
  @return array of records
*/
+ (NSMutableArray *)find_all:(NSString *)cond
{
    dbstmt *stmt = [self gen_stmt:cond];
    return  [self find_all_stmt:stmt];
}

/**
  @brief create dbstmt

  @param s condition
  @return dbstmt
*/
+ (dbstmt *)gen_stmt:(NSString *)cond
{
    NSString *sql;
    if (cond == nil) {
        sql = @"SELECT * FROM <%= cdef.tableName %>;";
    } else {
        sql = [NSString stringWithFormat:@"SELECT * FROM <%= cdef.tableName %> %@;", cond];
    }  
    dbstmt *stmt = [[Database instance] prepare:sql];
    return stmt;
}

/**
  Get first record matches the conditions

  @param stmt Statement
  @return array of records
*/
+ (<%= cdef.className %> *)find_first_stmt:(dbstmt *)stmt
{
    if ([stmt step] == SQLITE_ROW) {
        <%= cdef.baseClassName %> *e = [[self class] new];
        [e _loadRow:stmt];
        return (<%= cdef.className %> *)e;
    }
    return nil;
}

/**
  Get all records match the conditions

  @param stmt Statement
  @return array of records
*/
+ (NSMutableArray *)find_all_stmt:(dbstmt *)stmt
{
    NSMutableArray *array = [NSMutableArray new];

    while ([stmt step] == SQLITE_ROW) {
        <%= cdef.baseClassName %> *e = [[[self class] alloc] init];
        [e _loadRow:stmt];
        [array addObject:e];
    }
    return array;
}

- (void)_loadRow:(dbstmt *)stmt
{
    self.pid = [stmt colInt:0];
<%
    i = 1
    cdef.members.each do |m|
      type = m.type
      method = "col" + getMethodType(type)
-%>
    self.<%= m.propName %> = [stmt <%= method %>:<%= i %>];
<%    i += 1 -%>
<%  end -%>
}

#pragma mark Create operations

- (void)_insert
{
    Database *db = [Database instance];
    dbstmt *stmt;
    
    //[db beginTransaction];
<%
  arglist = ""
  cdef.members.each do |m|
    arglist += ",?"
  end
-%>
    stmt = [db prepare:@"INSERT INTO <%= cdef.tableName %> VALUES(NULL<%= arglist %>);"];
<%
    i = 0
    cdef.members.each do |m|
      method = "bind" + getMethodType(m.type)
-%>
    [stmt <%= method %>:<%= i %> val:<%= m.memberName %>];
<%    i += 1 -%>
<%  end -%>
    [stmt step];

    self.pid = [db lastInsertRowId];

    //[db commitTransaction];

    [[Database instance] setModified];
}

#pragma mark Update operations

- (void)_update
{
    Database *db = [Database instance];
    //[db beginTransaction];

    dbstmt *stmt = [db prepare:@"UPDATE <%= cdef.tableName %> SET "
<%
  isFirst = true
  cdef.members.each do |m|
    if (isFirst)
      isFirst = false
-%>
        "<%= m.fieldName %> = ?"
<%  else -%>
        ",<%= m.fieldName %> = ?"
<%  end -%>
<% end -%>
        " WHERE <%= vers["PKEY"] %> = ?;"];
<% 
    i = 0
    cdef.members.each do |m|
      method = "bind" + getMethodType(m.type)
-%>
    [stmt <%= method %>:<%= i %> val:<%= m.memberName %>];
<%
      i += 1
    end
-%>
    [stmt bindInt:<%= i %> val:mPid];

    [stmt step];
    //[db commitTransaction];

    [[Database instance] setModified];
}

#pragma mark Delete operations

/**
  @brief Delete record
*/
- (void)delete
{
    Database *db = [Database instance];

    dbstmt *stmt = [db prepare:@"DELETE FROM <%= cdef.tableName %> WHERE <%= vers["PKEY"] %> = ?;"];
    [stmt bindInt:0 val:mPid];
    [stmt step];

    [[Database instance] setModified];
}

/**
  @brief Delete all records
*/
+ (void)delete_cond:(NSString *)cond
{
    Database *db = [Database instance];

    if (cond == nil) {
        cond = @"";
    }
    NSString *sql = [NSString stringWithFormat:@"DELETE FROM <%= cdef.tableName %> %@;", cond];
    [db exec:sql];

    [[Database instance] setModified];
}

+ (void)delete_all
{
    [<%= cdef.baseClassName %> delete_cond:nil];
}

/**
 * get table sql
 */
+ (void)getTableSql:(NSMutableString *)s
{
    [s appendString:@"DROP TABLE <%= cdef.tableName %>;\n"];
    [s appendString:@"CREATE TABLE <%= cdef.tableName %> (key INTEGER PRIMARY KEY"];

<% cdef.members.each do |m| -%>
    [s appendFormat:@", <%= m.fieldName %> <%= m.type %>"];
<% end -%>    
    [s appendString:@");\n"];

    NSMutableArray *ary = [self find_all:nil];
    for (<%= cdef.baseClassName %> *e in ary) {
        [e getInsertSql:s];
        [s appendString:@"\n"];
    }
}

/**
 * get "INSERT" SQL
 */
- (void)getInsertSql:(NSMutableString *)s
{
    [s appendFormat:@"INSERT INTO <%= cdef.tableName %> VALUES(%d", mPid];
<% cdef.members.each do |m| -%>
    [s appendString:@","];
    [s appendString:[self quoteSqlString:<%= getToString(m.type, m.memberName) %>]];
<% end -%>
    [s appendString:@");"];
}

#pragma mark Internal functions

+ (NSString *)tableName
{
    return @"<%= cdef.tableName %>";
}

@end
